<div>
    <button id="newsletter-subscribe-button" style="display: none; border: none" class="wp-block-button__link has-vivid-cyan-blue-background-color has-background">Subscribe</a>
</div>

<script>
    let subscribedId = 'subscribed-message';
    function onClick() {
        let promise;
        let email = document.getElementById('email-text-input');
        let isLoggedIn = document.getElementsByTagName('body')[0].classList.contains("logged-in")
        if (isLoggedIn) { 
            promise = fetch('/wp-json/newsletter/v1/subscribe', { 
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'X-WP-Nonce': '{{wordpressNonce}}'
                },
                body: '{}'
            });
        } else if (email && email.value) {
            promise = fetch('/wp-json/newsletter/v1/subscribe', { 
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: '{"email": ' + email.value + '}'
            });
        } 
        promise.then(response => response.json())
            .then(data => {
                if (data.status == 'subscribed') {
                    showSubscribedMessage();
                } else {
                    console.log(data);
                }
            }).catch(err => console.error(err));
    }

    function showNonMemberSubscribe() {
        let button = document.getElementById('newsletter-subscribe-button');
        button.style.display = 'block';
        let email = document.createElement('input');
        email.type = "text";
        email.id = "email-text-input";
        email.style.display = 'block';
        email.style.marginBottom = '2em';
        button.parentNode.prepend(email);
        let label = document.createElement('p');
        label.innerText = 'Enter your email address to subscribe to the newsletter:';
        button.parentNode.prepend(label);
        button.onclick = onClick;
        subMessage = document.getElementById(subscribedId);
        if (subMessage) {
            subMessage.style.display = 'none';
        }
    }

    function showSubscribedMessage() {
        let button = document.getElementById('newsletter-subscribe-button');
        button.style.display = 'none';
        let subMessage = document.createElement('p');
        subMessage.id =  subscribedId;
        subMessage.innerText = 'You are currently subscribed to the SAIL newsletter.';
        subMessage.style.display = 'block';
        button.parentNode.appendChild(subMessage);
    }

    function showSubscribeButton() {
        let button = document.getElementById('newsletter-subscribe-button');
        button.style.display = 'block';
        button.onclick = onClick;
        subMessage = document.getElementById(subscribedId);
        if (subMessage) {
            subMessage.style.display = 'none';
        }
    }

    window.onload = function() {
        if (document.getElementsByTagName('body')[0].classList.contains("logged-in")) {
            showSubscribeButton();
        } else if ({{isSubscribed}}) {
            showSubscribedMessage();
        } else {
            showNonMemberSubscribe();
        }
    }
</script>
